{% extends 'base.html' %}

{% block content %}
<div class="row g-4 mb-4">
    <!-- Welcome/Header (Optional, or rely on Topbar) -->
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h4 class="fw-bold mb-0">Dashboard Overview</h4>
        <a href="{% url 'home' %}" class="btn btn-outline-success">
            <i class="bi bi-grid-1x2-fill"></i> Browse Marketplace
        </a>
    </div>
</div>

<!-- Stats Grid -->
<div class="row g-4 mb-4">
    <!-- Listings Stat -->
    <div class="col-12 col-md-4">
        <div class="custom-card stat-card bg-white">
            <div>
                <h6 class="text-muted text-uppercase fw-bold mb-2" style="font-size: 0.8rem;">Total Listings</h6>
                <h2 class="fw-bold mb-0 text-dark">{{ listings.count }}</h2>
            </div>
            <div class="stat-icon bg-soft-green">
                <i class="bi bi-grid-fill text-success"></i>
            </div>
        </div>
    </div>

    <!-- Revenue Stat -->
    <div class="col-12 col-md-4">
        <div class="custom-card stat-card bg-white">
            <div>
                <h6 class="text-muted text-uppercase fw-bold mb-2" style="font-size: 0.8rem;">Total Revenue</h6>
                <h2 class="fw-bold mb-0 text-dark">KSh {{ total_sales }}</h2>
            </div>
            <div class="stat-icon bg-soft-blue">
                <i class="bi bi-currency-dollar text-primary"></i>
            </div>
        </div>
    </div>

    <!-- Orders Stat -->
    <div class="col-12 col-md-4">
        <div class="custom-card stat-card bg-white">
            <div>
                <h6 class="text-muted text-uppercase fw-bold mb-2" style="font-size: 0.8rem;">Pending Orders</h6>
                <h2 class="fw-bold mb-0 text-dark">{{ pending_orders }}</h2>
            </div>
            <div class="stat-icon bg-soft-orange">
                <i class="bi bi-clock-history text-warning"></i>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Listings Table -->
    <div class="col-12 col-xl-6">
        <div class="custom-card p-4 h-100">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold mb-0">My Products</h5>
                <a href="{% url 'create_listing' %}" class="btn btn-sm btn-primary-custom">
                    <i class="bi bi-plus-lg"></i> Add New
                </a>
            </div>

            <div class="table-responsive">
                <table class="table modern-table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for listing in listings %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center gap-3">
                                    {% if listing.image %}
                                    <img src="{{ listing.image.url }}" class="rounded-3"
                                        style="width: 40px; height: 40px; object-fit: cover;">
                                    {% else %}
                                    <div class="rounded-3 bg-light d-flex align-items-center justify-content-center text-muted"
                                        style="width: 40px; height: 40px;">
                                        <i class="bi bi-image"></i>
                                    </div>
                                    {% endif %}
                                    <span class="fw-medium">{{ listing.title }}</span>
                                </div>
                            </td>
                            <td class="fw-bold">KSh {{ listing.price }}</td>
                            <td>
                                {{ listing.quantity }} <span class="text-muted text-uppercase"
                                    style="font-size: 0.75rem;">{{ listing.unit }}</span>
                            </td>
                            <td>
                                {% if listing.is_available %}
                                <span class="badge bg-soft-green text-success badge-custom">Active</span>
                                {% else %}
                                <span class="badge bg-light text-muted badge-custom">Inactive</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="{% url 'edit_listing' listing.id %}"
                                        class="btn btn-link text-primary p-0 me-3" title="Edit">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>
                                    <form action="{% url 'delete_listing' listing.id %}" method="post" class="d-inline"
                                        onsubmit="return confirm('Delete this listing?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-link text-danger p-0" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">
                                No products listed yet.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Recent Orders -->
    <div class="col-12 col-xl-6">
        <div class="custom-card p-4 h-100">
            <h5 class="fw-bold mb-4">Recent Orders</h5>
            <div class="table-responsive">
                <table class="table modern-table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Item</th>
                            <th>Buyer</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td class="text-muted">#{{ order.id }}</td>
                            <td>{{ order.listing.title }}</td>
                            <td>
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>{{ order.buyer.username }}</span>
                                    <a href="{% url 'send_message' order.buyer.username %}" class="text-primary"
                                        title="Message Buyer">
                                        <i class="bi bi-chat-dots"></i>
                                    </a>
                                </div>
                            </td>
                            <td>
                                {% if order.status == 'PENDING' %}
                                <form action="{% url 'update_order_status' order.id %}" method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="status" value="DELIVERED">
                                    <button type="submit"
                                        class="badge bg-soft-orange text-warning border-0 badge-custom cursor-pointer"
                                        title="Click to Mark Complete">
                                        Pending
                                    </button>
                                </form>
                                {% else %}
                                <form action="{% url 'update_order_status' order.id %}" method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="status" value="PENDING">
                                    <button type="submit"
                                        class="badge bg-soft-green text-success border-0 badge-custom cursor-pointer"
                                        title="Click to Mark Pending">
                                        Completed
                                    </button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center py-4 text-muted">
                                No orders received yet.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}